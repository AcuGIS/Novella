{% extends "layout.twig" %}

{% block title %}GIS Catalog{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold">GIS Catalog</h1>
        <a href="/catalog/add" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Add Dataset
        </a>
    </div>

    <!-- Search and Filters -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <form action="/catalog" method="GET" class="space-y-4">
            <div class="flex gap-4">
                <div class="flex-1">
                    <label for="search" class="block text-sm font-medium text-gray-700">Search</label>
                    <input type="text" name="q" id="search" value="{{ request.query.q }}"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                        placeholder="Search datasets...">
                </div>
                <div class="w-48">
                    <label for="metadata_standard" class="block text-sm font-medium text-gray-700">Metadata Standard</label>
                    <select name="metadata_standard" id="metadata_standard"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">All Standards</option>
                        <option value="ISO 19115" {% if request.query.metadata_standard == 'ISO 19115' %}selected{% endif %}>ISO 19115</option>
                        <option value="ISO 19139" {% if request.query.metadata_standard == 'ISO 19139' %}selected{% endif %}>ISO 19139</option>
                        <option value="INSPIRE" {% if request.query.metadata_standard == 'INSPIRE' %}selected{% endif %}>INSPIRE</option>
                        <option value="FGDC" {% if request.query.metadata_standard == 'FGDC' %}selected{% endif %}>FGDC</option>
                        <option value="OGC CSW" {% if request.query.metadata_standard == 'OGC CSW' %}selected{% endif %}>OGC CSW</option>
                        <option value="Dublin Core" {% if request.query.metadata_standard == 'Dublin Core' %}selected{% endif %}>Dublin Core</option>
                    </select>
                </div>
                <div class="w-48">
                    <label for="status" class="block text-sm font-medium text-gray-700">Status</label>
                    <select name="status" id="status"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">All Statuses</option>
                        <option value="draft" {% if request.query.status == 'draft' %}selected{% endif %}>Draft</option>
                        <option value="published" {% if request.query.status == 'published' %}selected{% endif %}>Published</option>
                        <option value="archived" {% if request.query.status == 'archived' %}selected{% endif %}>Archived</option>
                    </select>
                </div>
            </div>
            <div class="flex justify-end">
                <button type="submit"
                    class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Search
                </button>
            </div>
        </form>
    </div>

    <!-- Debug Info -->
    {% if datasets is defined %}
    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4">
        <p>Debug: Found {{ datasets|length }} datasets</p>
    </div>
    {% endif %}

    <!-- Datasets List -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold mb-4">Datasets</h2>
        {% if datasets is defined and datasets|length > 0 %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for dataset in datasets %}
            <div class="border rounded-lg overflow-hidden">
                <div class="p-4">
                    {% if dataset.thumbnail_path %}
                    <img src="/assets/thumbnails/{{ dataset.thumbnail_path }}" alt="Thumbnail" style="width:100%; height:120px; object-fit:cover; border-radius:8px; margin-bottom:12px; display:block;">
                    {% else %}
                    <img src="/assets/thumbnails/default.png" alt="Thumbnail" style="width:100%; height:120px; object-fit:cover; border-radius:8px; margin-bottom:12px; display:block;">
                    {% endif %}
                    <h3 class="text-lg font-medium text-gray-900 mb-2">{{ dataset.title }}</h3>
                    <p class="text-gray-600 text-sm mb-4">{{ dataset.description }}</p>
                    
                    <!-- Quality Score -->
                    <div class="mb-4">
                        <div class="flex items-center">
                            <span class="text-sm font-medium text-gray-700 mr-2">Quality Score:</span>
                            <div class="flex-1 h-2 bg-gray-200 rounded-full">
                                <div class="h-2 rounded-full {% if dataset.quality_score >= 80 %}bg-green-500{% elseif dataset.quality_score >= 60 %}bg-yellow-500{% else %}bg-red-500{% endif %}"
                                     style="width: {{ dataset.quality_score }}%"></div>
                            </div>
                            <span class="text-sm text-gray-600 ml-2">{{ dataset.quality_score }}%</span>
                        </div>
                    </div>

                    <!-- Map Preview -->
                    {% if dataset.geometry %}
                    <div class="mb-4 h-48 bg-gray-100 rounded-lg overflow-hidden">
                        <div id="map-{{ dataset.id }}" class="w-full h-full"></div>
                    </div>
                    {% endif %}

                    <!-- Harvest Source -->
                    {% if dataset.harvest_source_name %}
                    <div class="mb-4">
                        <span class="text-sm text-gray-500">Source: {{ dataset.harvest_source_name }}</span>
                    </div>
                    {% endif %}

                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-500">Last updated: {{ dataset.updated_at }}</span>
                        <a href="/catalog/{{ dataset.id }}" class="text-blue-600 hover:text-blue-900">View Details</a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-8">
            <p class="text-gray-500 mb-4">No datasets found.</p>
            <a href="/catalog/add" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                Add Your First Dataset
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- OpenLayers Map Script -->
<script src="https://cdn.jsdelivr.net/npm/ol@v7.4.0/ol.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.4.0/ol.css">
<script>
document.addEventListener('DOMContentLoaded', function() {
    {% for dataset in datasets %}
    {% if dataset.geometry %}
    // Create map for dataset {{ dataset.id }}
    const map{{ dataset.id }} = new ol.Map({
        target: 'map-{{ dataset.id }}',
        layers: [
            new ol.layer.Tile({
                source: new ol.source.OSM()
            })
        ],
        view: new ol.View({
            center: ol.proj.fromLonLat([0, 0]),
            zoom: 2
        })
    });

    // Add dataset geometry
    const geometry = {{ dataset.geometry|json_encode|raw }};
    const feature = new ol.Feature({
        geometry: new ol.format.GeoJSON().readGeometry(geometry)
    });

    const vectorLayer = new ol.layer.Vector({
        source: new ol.source.Vector({
            features: [feature]
        }),
        style: new ol.style.Style({
            stroke: new ol.style.Stroke({
                color: 'rgba(0, 0, 255, 1.0)',
                width: 2
            }),
            fill: new ol.style.Fill({
                color: 'rgba(0, 0, 255, 0.1)'
            })
        })
    });

    map{{ dataset.id }}.addLayer(vectorLayer);
    map{{ dataset.id }}.getView().fit(feature.getGeometry().getExtent(), {
        padding: [50, 50, 50, 50],
        maxZoom: 10
    });
    {% endif %}
    {% endfor %}
});
</script>
{% endblock %} 